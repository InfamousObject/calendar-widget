generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String                  @id
  email                   String                  @unique
  name                    String?
  passwordHash            String?
  emailVerified           DateTime?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  businessName            String?
  timezone                String                  @default("America/New_York")
  widgetId                String                  @unique @default(cuid())
  stripeCustomerId        String?                 @unique
  stripeSubscriptionId    String?                 @unique
  // Stripe Connect fields (for receiving appointment payments)
  stripeConnectAccountId  String?                 @unique // Connected account ID
  stripeConnectOnboarded  Boolean                 @default(false) // Has completed onboarding
  stripeConnectPayoutsEnabled Boolean             @default(false) // Can receive payouts
  subscriptionTier        String                  @default("free")
  subscriptionStatus      String?
  billingInterval         String?
  currentPeriodEnd        DateTime?
  cancelAtPeriodEnd       Boolean                 @default(false)
  monthlyBookings         Int                     @default(0)
  monthlyChatMessages     Int                     @default(0)
  lastUsageReset          DateTime                @default(now())
  appointments            Appointment[]
  appointmentTypes        AppointmentType[]
  availability            Availability[]
  bookingFormFields       BookingFormField[]
  calendars               CalendarConnection[]
  chatbotConfig           ChatbotConfig?
  chatbotUsage            ChatbotUsage[]
  conversations           Conversation[]
  dateOverrides           DateOverride[]
  forms                   Form[]
  formSubmissions         FormSubmission[]
  knowledgeBase           KnowledgeBase[]
  knowledgeBaseCategories KnowledgeBaseCategory[]
  subscription            Subscription?
  teamMembers             TeamMember[]            @relation("AccountOwner")
  teamMemberships         TeamMember[]            @relation("TeamMemberUser")
  usageRecords            UsageRecord[]
  widgetConfig            WidgetConfig?
  cancellationSurveys     CancellationSurvey[]
  supportTickets          SupportTicket[]
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  stripeSubscriptionId String    @unique
  stripePriceId        String
  stripeCustomerId     String
  tier                 String
  billingInterval      String
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime?
  trialEnd             DateTime?
  includedSeats        Int       @default(1)
  additionalSeats      Int       @default(0)
  totalSeats           Int       @default(1)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeCustomerId])
}

model CalendarConnection {
  id           String   @id @default(cuid())
  userId       String
  provider     String   // "google" or "outlook"
  source       String   @default("manual") // "clerk" or "manual" - how the connection was established

  // Encrypted email (PII protection)
  email        String   @db.Text // Encrypted email (hex string)
  emailIv      String   @default("") // IV for email
  emailAuth    String   @default("") // Auth tag for email

  // Encrypted OAuth tokens (protect calendar access)
  // For source="clerk", these may be empty as tokens come from Clerk
  accessToken      String   @db.Text // Encrypted access token (hex string)
  accessTokenIv    String   @default("") // IV for access token
  accessTokenAuth  String   @default("") // Auth tag for access token

  refreshToken     String   @db.Text // Encrypted refresh token (hex string)
  refreshTokenIv   String   @default("") // IV for refresh token
  refreshTokenAuth String   @default("") // Auth tag for refresh token

  expiresAt    DateTime
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AppointmentType {
  id               String        @id @default(cuid())
  userId           String
  name             String
  description      String?
  duration         Int
  color            String        @default("#3b82f6")
  bufferBefore     Int           @default(0)
  bufferAfter      Int           @default(0)
  active           Boolean       @default(true)
  enableGoogleMeet Boolean       @default(false) // Auto-generate Google Meet link
  // Payment settings
  price            Int?          // Price in cents (null = free)
  currency         String        @default("usd")
  requirePayment   Boolean       @default(false) // Require payment before booking
  depositPercent   Int?          // Percentage for deposit (null = full payment required)
  refundPolicy     String        @default("full") // full, partial, none
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  appointments     Appointment[]
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Availability {
  id          String   @id @default(cuid())
  userId      String
  dayOfWeek   Int
  startTime   String
  endTime     String
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, dayOfWeek])
}

model DateOverride {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime
  isAvailable Boolean
  startTime   String?
  endTime     String?
  reason      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
}

model Appointment {
  id                String          @id @default(cuid())
  userId            String
  appointmentTypeId String
  startTime         DateTime
  endTime           DateTime
  timezone          String
  visitorName       String
  visitorEmail      String
  visitorPhone      String?
  notes             String?
  formResponses     Json?
  status            String
  calendarEventId   String?
  meetingLink       String?         // Video conferencing link (Google Meet, Zoom, etc.)
  meetingProvider   String?         // "google_meet", "zoom", etc.
  // Payment fields
  paymentIntentId   String?         // Stripe Payment Intent ID
  paymentStatus     String?         // pending, paid, refunded, failed
  amountPaid        Int?            // Amount paid in cents
  currency          String?         // Currency of payment
  refundId          String?         // Stripe Refund ID if refunded
  refundAmount      Int?            // Refund amount in cents
  cancellationToken String          @unique
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  appointmentType   AppointmentType @relation(fields: [appointmentTypeId], references: [id])
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([appointmentTypeId, startTime])
  @@index([status, startTime])
  @@index([cancellationToken])
  @@index([paymentIntentId])
}

model BookingFormField {
  id          String   @id @default(cuid())
  userId      String
  label       String
  fieldType   String
  placeholder String?
  required    Boolean  @default(false)
  options     Json?
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, order])
}

model Form {
  id          String           @id @default(cuid())
  userId      String
  name        String
  description String?
  fields      Json
  settings    Json
  active      Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  submissions FormSubmission[]
}

model FormSubmission {
  id        String   @id @default(cuid())
  formId    String
  userId    String

  // Encrypted form data (PII protection)
  data      String   @db.Text // Encrypted hex string (was Json)
  dataIv    String   @default("") // Initialization vector
  dataAuth  String   @default("") // Authentication tag

  ipAddress String?
  userAgent String?
  status    String   @default("new")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  form      Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status, createdAt])
  @@index([formId, createdAt])
}

model WidgetConfig {
  id              String   @id @default(cuid())
  userId          String   @unique
  primaryColor    String   @default("#3b82f6")
  backgroundColor String   @default("#ffffff")
  textColor       String   @default("#1f2937")
  borderRadius    String   @default("medium")
  fontFamily      String   @default("system")
  position        String   @default("bottom-right")
  offsetX         Int      @default(20)
  offsetY         Int      @default(20)
  showOnMobile    Boolean  @default(true)
  delaySeconds    Int      @default(0)
  logoUrl         String?
  businessName    String?
  welcomeMessage  String   @default("Book an appointment with us")
  timeFormat      String   @default("12h")
  requirePhone    Boolean  @default(false)
  showNotes       Boolean  @default(true)
  daysToDisplay   Int      @default(7)
  widgetDaysToDisplay Int  @default(4)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ChatbotConfig {
  id                 String         @id @default(cuid())
  userId             String         @unique
  enabled            Boolean        @default(false)
  botName            String         @default("Assistant")
  greetingMessage    String         @default("Hi! How can I help you today?")
  tone               String         @default("professional")
  customInstructions String?
  enableFaq          Boolean        @default(true)
  enableLeadQual     Boolean        @default(true)
  enableScheduling   Boolean        @default(true)
  model              String         @default("claude-haiku-4-5-20251001")
  maxTokens          Int            @default(1024)
  temperature        Float          @default(0.7)
  messageLimit       Int            @default(100)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  costLimitCents     Int            @default(5000)
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  usage              ChatbotUsage[]
  conversations      Conversation[]
}

model ChatbotUsage {
  id              String        @id @default(cuid())
  userId          String
  chatbotConfigId String
  messagesCount   Int           @default(0)
  inputTokens     Int           @default(0)
  outputTokens    Int           @default(0)
  estimatedCost   Int           @default(0)
  month           Int
  year            Int
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  chatbotConfig   ChatbotConfig @relation(fields: [chatbotConfigId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([userId, year, month])
}

model KnowledgeBaseCategory {
  id          String          @id @default(cuid())
  userId      String
  name        String
  slug        String
  description String?
  color       String          @default("#3b82f6")
  order       Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  articles    KnowledgeBase[]
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
}

model KnowledgeBase {
  id         String                 @id @default(cuid())
  userId     String
  categoryId String?
  title      String
  slug       String
  content    String
  excerpt    String?
  type       String                 @default("article")
  status     String                 @default("draft")
  isPinned   Boolean                @default(false)
  tags       Json?
  metadata   Json?
  url        String?
  viewCount  Int                    @default(0)
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt
  category   KnowledgeBaseCategory? @relation(fields: [categoryId], references: [id])
  user       User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
  @@index([userId, status])
  @@index([userId, categoryId])
}

model Conversation {
  id              String        @id @default(cuid())
  userId          String
  chatbotConfigId String
  visitorId       String
  messages        Json
  leadQualified   Boolean       @default(false)
  leadData        Json?
  outcome         String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  chatbotConfig   ChatbotConfig @relation(fields: [chatbotConfigId], references: [id])
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([chatbotConfigId])
}

model TeamMember {
  id                   String    @id @default(cuid())
  accountId            String
  userId               String?
  email                String
  name                 String?
  role                 String    @default("member") // owner, admin, member
  status               String    @default("pending") // pending, active, removed
  invitationToken      String?   @unique
  invitationExpiry     DateTime?
  receiveNotifications Boolean   @default(true) // Receive booking email notifications
  invitedAt            DateTime  @default(now())
  joinedAt             DateTime?
  removedAt            DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  accountOwner         User      @relation("AccountOwner", fields: [accountId], references: [id], onDelete: Cascade)
  user                 User?     @relation("TeamMemberUser", fields: [userId], references: [id])

  @@unique([accountId, email])
  @@index([accountId])
  @@index([userId])
  @@index([email])
  @@index([invitationToken])
}

model UsageRecord {
  id        String   @id @default(cuid())
  userId    String
  type      String
  metadata  Json?
  billable  Boolean  @default(true)
  billed    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, type, createdAt])
  @@index([userId, billable, billed])
}

model WebhookEvent {
  id        String   @id @default(cuid())
  provider  String   // 'stripe' or 'clerk'
  eventId   String   @unique
  eventType String
  processed Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([provider, eventId])
}

model CancellationSurvey {
  id                String    @id @default(cuid())
  userId            String
  reason            String    // too_expensive, not_using, missing_features, switched, other
  reasonDetails     String?   @db.Text
  subscriptionTier  String
  monthsSubscribed  Int
  feedback          String?   @db.Text

  // Re-engagement
  discountCode      String?
  discountRedeemed  Boolean   @default(false)
  reengagementSent  Boolean   @default(false)

  createdAt         DateTime  @default(now())

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reason])
}

model SupportTicket {
  id                String    @id @default(cuid())
  userId            String
  email             String
  subject           String
  description       String    @db.Text
  category          String    @default("general")
  priority          String    @default("normal")
  status            String    @default("open")

  // Context
  currentPage       String?
  browserInfo       String?
  subscriptionTier  String?
  screenshotUrl     String?

  // AI analysis
  aiDiagnosis       String?   @db.Text
  aiSuggestedFix    String?   @db.Text

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
}
